"use strict";var socket=io.connect(),app=angular.module("TaigaApp",["angularFileUpload","ngImgCrop","ui.router","ngSanitize"]);angular.module("TaigaApp").config(["$stateProvider","$urlRouterProvider",function(e,o){e.state("home",{url:"/",views:{room_select:{templateUrl:"./partials/chat/roomselect.html",controller:"RoomSelectController"},chat_room:{templateUrl:"./partials/chat/chatroom.html",controller:"ChatWindowController"},user_list:{templateUrl:"./partials/user/userlist.html",controller:"UserListController"},friend_list:{templateUrl:"./partials/user/friendlist.html",controller:"UserListController"},options:{templateUrl:"./partials/user/me.html",controller:"RoomSelectController"}}}),o.otherwise("/")}]),String.prototype.replaceAll=function(e,o){return this.split(e).join(o)},String.prototype.isEmpty=function(){return this.match(/\S/)?0:1},angular.module("TaigaApp").factory("emoji",["$http","$q","$stateParams",function(e,o,t){var r={show_emoji_picker:0,emoji_filter:"people",emojis:[]};return r.emojipicker_switch=function(){r.show_emoji_picker=!r.show_emoji_picker,r.show_emoji_picker&&r.loadEmoji()},r.changeEmojiFilter=function(e){r.emojis[0]||r.loadEmoji(),r.show_emoji_picker=1,r.emoji_filter=e},r.showEmoji=function(e){return e.category===r.emoji_filter&&r.show_emoji_picker},r.loadEmoji=function(){for(var e in emoji_list)r.emojis.push(emoji_list[e])},r.emoji=function(){twemoji.parse(document,{folder:"svg",ext:".svg"}),twemoji.parse(document.body,{folder:"svg",ext:".svg"})},r}]),angular.module("TaigaApp").factory("fetcher",["$http","$location","$q",function(e,o,t){var r={};return r.roomname=o.search().room,r.type="public",r.getUsername=function(){return e.get("/auth/getUsername").then(function(e){return e.data})},r.getRoomlist=function(){return e.get("/graph/roomlist").then(function(e){return e.data.roomlist})},r.getRoomData=function(){o.search().room;return e.get("/graph/rooms/"+r.type+"/"+o.search().room).then(function(e){return e.data})},r.getRoomname=function(){return o.search().room},r.getUserlist=function(){var o=r.roomname;return e.get("/graph/userlist/"+r.type+"/"+o).then(function(e){return e.data})},r.getFriendRequestsData=function(){var o=t.defer();r.roomname;return e.get("/graph/friend_requests/").then(function(e){e?o.resolve(e.data):o.reject("No room")},function(e){o.reject(e)}),o.promise},r.getMessages=function(o){var n=t.defer();return e.get("/graph/messages/"+r.type+"/"+o+"/"+r.message_multiplier).then(function(e){e?n.resolve(e.data):n.reject("No messages")},function(e){n.reject(e)}),n.promise},r.getRoomname=function(){return void 0!=o.search().room?o.search().room:""},r.increaseMessageNumber=function(){return r.message_multiplier++,e.get("/graph/messages/"+r.type+"/"+r.roomname+"/"+r.message_multiplier).then(function(e){return r.messages=e.data.concat(r.messages),console.log(e.data),r.messages})},r.reloadMessages=function(){r.roomname=o.search().room;var t=r.roomname;r.messages=[],r.message_multiplier=1,e.get("/graph/messages/"+r.type+"/"+t+"/"+r.message_multiplier).then(function(e){r.messages=e.data})},r.reloadMessages(),r.lastroom="",r.setLastRoom=function(e){r.lastroom=e},r.getLastRoom=function(){return r.lastroom},r.updateAll=function(){r.reloadMessages()},r.reloadData=function(e){r.getUsername().then(function(t){e.username=t,e.profilePictureAddress="image/profile/profile-"+e.username,r.getRoomlist().then(function(o){e.roomlist=o}),void 0===o.search().room?socket.emit("join room",{roomname:"",username:e.username}):($(".chat").removeClass("displayNone"),socket.emit("join room",{roomname:o.search().room,username:e.username})),events.emit("reset room",{}),events.emit("change room",{})})},r}]),angular.module("TaigaApp").factory("room",["$http","$q","$stateParams","fetcher","$anchorScroll",function(e,o,t,r,n){var a=r;return a.messages=[],r.getRoomData().then(function(e){a.room=e}),a.getRoomname=function(){return this.roomname},a.sendMessage=function(o){e.post("/graph/sendMessage/",o)},a.addMessage=function(o){e.post("/addMessage",o),a.messages.push(o)},a.getRoom=function(){return a.room},a}]),angular.module("TaigaApp").factory("upload_factory",["$http","FileUploader","FileItem","$location",function(e,o,t,r){var n={};return n.init=function(e,t){var n;switch(e){case"room":n=new o,n.url="/upload/background/",n.removeAfterUpload=1,n.alias="file";var a=function(e){var o=e.currentTarget.files[0],r=new FileReader;r.onload=function(e){t.$apply(function(o){o.myImage=e.target.result})},r.readAsDataURL(o)};angular.element(document.querySelector("#fileInput")).on("change",a);break;case"chat":n=new o,n.url="/upload/image/public/"+r.search().room,n.autoUpload=1,n.removeAfterUpload=1,n.alias="file",n.onSuccessItem=function(e,o,r,n){t.room_factory.sendMessage(o)}}return n},n.basicFunctions=function(o){var t={};return t.handleCropUpload=function(){var t={endodedImage:o.myCroppedImage};e.post("/upload/profile/",t).then(function(e){o.profilePictureAddress+="?"})},t.handleUpload=function(){o.uploader.getNotUploadedItems()[0].onSuccess=function(e,o,t){$(".chat").css("background-image","url('/image/background/?t="+Date.now()+"'")},o.uploader.uploadItem(0)},t},n}]),function(){function e(e,o,t,r,n,a,s,i,m){function c(e){e.autoplay="on"}function u(e){return"image"===e.message_type?"/image/chat/"+e.body:""}function l(){return Date.now()}e.emoji=s,e.room_factory=n,e.user_color="#2ecc71",e.uploader=a.init("chat",e),e.newMessage="",e.messages=e.room_factory.messages,e.playVideo=c,e.showImage=u,e.showVideo=function(e){return"video"===e.message_type?"/image/chat/"+e.body:""},e.getColor=function(e){return t.get("/graph/getUserColor/"+e).then(function(e){return e.data})},n.getUsername().then(function(o){e.username=o}),e.getChatBubbleForm=function(e,o){return e==o?"usercb":"othercb"},e.bottomscroll=-1,e.gotoBottom=function(){$(".chatview").scrollTop($(".chatview")[0].scrollHeight)},e.init=function(){e.emoji.emoji()},e.gotoBottom(),e.addEmoji=function(o){e.newMessage+=o.char},e.sendMessage=function(){if(!e.newMessage.isEmpty()){var o=e.newMessage;for(var t in emoji_list)o=o.replaceAll(":"+t+":",emoji_list[t].char);var r={room_type:"public",username:e.username,roomname:i.search().room,body:o,timestamp:l(),message_type:"text"};e.room_factory.sendMessage(r),e.newMessage=""}},e.getMoreMessages=function(){n.increaseMessageNumber().then(function(e){m("message19")})},socket.on("message recieved",function(o){e.room_factory.addMessage(o),e.messages=e.room_factory.messages,m("bottom_message")}),e.$watch("newMessage",function(){}),events.on("reset room",function(){n.getRoomData().then(function(o){e.uploader.url="/upload/image/public/"+i.search().room,e.room_factory=n})}),$("#input_box").on("paste",function(){setTimeout(function(){},100)}),$(".chatbubbletext").on("loaded",function(){return $(this).addInputs($(".chatbubbletext").data("preview")),!0})}angular.module("TaigaApp").controller("ChatWindowController",["$scope","$stateParams","$http","$q","room","upload_factory","emoji","$location","$anchorScroll",e])}(),angular.module("TaigaApp").controller("RoomSelectController",["$scope","$http","fetcher","$location","$state","upload_factory",function(e,o,t,r,n,a){e.roomSearch="",t.reloadData(e),e.roomname=t.roomname,e.selectRoom=function(o){e.room=o,t.setLastRoom(o.roomname),r.url("?room="+o.roomname)},e.$on("$locationChangeSuccess",function(){t.updateAll();var o={roomname:r.search().room,username:e.username,lastroom:t.getLastRoom()};socket.emit("join room",o),r.search().room?$(".chat").removeClass("displayNone"):$(".chat").addClass("displayNone"),t.reloadData(e)}),socket.on("user joined",function(o){t.getRoomlist().then(function(o){e.roomlist=o,events.emit("change room",{})})}),e.myImage="",e.myCroppedImage="",e.$watch("profilePictureAddress",function(){$(".profileimg").attr("src",e.profilePictureAddress),$(".panelprofileimg").attr("src",e.profilePictureAddress)}),e.uploader=a.init("room",e),e.handleCropUpload=a.basicFunctions(e).handleCropUpload,e.handleUpload=a.basicFunctions(e).handleUpload,e.logOut=function(){logOut()},e.setColor=function(e){o.post("/graph/setUserColor/"+e)},e.getColor=function(e){return o.get("/graph/getUserColor/"+e).then(function(e){return e.data})}}]),angular.module("TaigaApp").controller("UserListController",["$scope","$http","$q","$stateParams","room",function(e,o,t,r,n){var a=function(){e.room=n,e.roomname=e.room.getRoomname(),n.getRoomData().then(function(o){e.room=o,e.roomname=e.room.roomname,e.prettyname=e.room.prettyname,e.userlist=o.usersOnline})};a(),e.roomname=e.room.roomname,e.username=r.username,e.type=r.type,events.on("change room",function(){$(".chatview").scrollTop($(".chatview")[0].scrollHeight),a()}),e.sendFriendRequest=function(e){o.post("/sendFriendRequest/"+e,{})},e.acceptFriendRequest=function(e){o.post("/acceptFriendRequest/"+e,{})},e.rejectFriendRequest=function(e){o.post("/rejectFriendRequest/"+e,{})},e.joinEvent=function(e){o.post("/graph/joinEvent/",{id:e}),e=""},socket.on("user joined",function(e){a()})}]),angular.module("TaigaApp").directive("contenteditable",["$sce",function(e){return{restrict:"A",require:"?ngModel",link:function(o,t,r,n){function a(){var e=t.html();r.stripBr&&"<br>"==e&&(e=""),n.$setViewValue(e)}n&&(n.$render=function(){t.html(e.getTrustedHtml(n.$viewValue||""))},t.on("blur keyup change",function(){o.$evalAsync(a)}),a())}}}]),angular.module("TaigaApp").directive("dataload",function(){return{link:function(e,o,t){window.setTimeout(function(){setTimeout(function(){jqueryUI()},500)})}}});